var PredictiveCitySelector={source:"/ajax/address-complete",strict:!0,tagit:0,fuzzy:!1,_disableLocation:!1,checkedLocationIds:[],_budapestDistricts:[],_budapestCheckList:null,selLocation:null,selPostalCode:null,selCityCode:null,actualMatch:null,lastMatch:[],actualSelected:null,_cachedAutocompleteSource:[],predictiveTextField:null,invalidValue:void 0,_xhr:null,delay:500,init:function(e,t,i,a,c){null===e?this._disableLocation=!0:this.selLocation=e,this.selPostalCode=i,this.selCityCode=a,this.predictiveTextField=t,this.fuzzy=!0===t.data("fuzzy"),this.initAutocomplete(t,i,c),-1!==navigator.userAgent.indexOf("Chrome")&&t.attr("autocomplete","new-password"),$(t).on("keyup",(function(e){13==e.keyCode&&this.blur()}))},initAutocomplete:function(e,t,i){var a={delay:PredictiveCitySelector.delay,minLength:2,position:{my:"left top",at:"left bottom"},source:PredictiveCitySelector.autocompleteSource,select:PredictiveCitySelector.onAutocompleteSelect,change:function(e,t){},close:function(e,t){e.bubbles||PredictiveCitySelector.onAutocompleteCloseWithoutSelect(e,t)}};""!==i&&(a.appendTo=i),e.autocomplete(a)},initCityCompleteByZipcode:function(e,t){e.change((function(){$.ajax({url:PredictiveCitySelector.source,type:"POST",dataType:"json",async:!0,cache:!1,data:{zipcode:e.val(),getdata:!0,lang:prof.i18n.currentLanguage()},success:function(e){e&&(e.label=e.city,PredictiveCitySelector.actualMatch=[e],t.val(e.city),PredictiveCitySelector.afterAjaxSuccess(e))}})}))},initZipcodeCompleteByCity:function(e,t){this.selPostalCode=e,this.initAutocomplete(t),t.focus((function(){$(this).data("former_value",$(this).val())})),t.bind("blur",(function(){if($(this).data("former_value")==$(this).val())return $(this).data("former_value",""),!0;$(this).data("former_value","");var e=t.val();if(null!=PredictiveCitySelector.actualMatch){var i=$.map(PredictiveCitySelector.actualMatch,(function(e,t){return e.label}));-1==$.inArray(e,i)&&t.val("")}}))},afterAjaxSuccess:function(e){},initWithTagIt:function(e,t,i,a,c){this.selLocation=e,this.selPostalCode=i;var o={singleField:!1,fieldName:c||"location_id[]",allowSpaces:!0,autocomplete:{delay:0,minLength:2,source:PredictiveCitySelector.autocompleteSource,change:function(e,i){null==i.item||null==i.item?(t.val(""),t.attr("disabled",!1)):t.attr("disabled",!0)},open:function(e,t){$(".ui-autocomplete").width($(".ui-autocomplete").width()+20)},autoFocus:!0,close:function(e,i){return!!(e.target.value.length>2&&PredictiveCitySelector.actualMatch.length)&&(t.tagit("createTag",PredictiveCitySelector.actualMatch[0].label),!1)}},beforeTagAdded:function(e,t){return $(window).trigger("tagitBeforeTagAdded"),PredictiveCitySelector.forceMustMatch(t)},afterTagAdded:function(e,t){$(window).trigger("tagitAfterTagAdded")},afterTagRemoved:function(){$(window).trigger("tagitAfterTagRemoved")}};!0===a&&(o.autocomplete.select=function(e,i){return PredictiveCitySelector.actualSelected=i,t.tagit("createTag",i.item.value),!1},o.afterTagAdded=function(e,t){if($(window).trigger("tagitAfterTagAdded"),t.duringInitialization)for(var i=t.tag.attr("class").split(" "),a=0;a<i.length;a++)"type-city"===i[a]?t.tag.find("input").attr("name","city_id[]"):"type-location"===i[a]&&-1<i[a].indexOf("id-")&&t.tag.find("input").val(i[a].replace("id-",""));else void 0!==PredictiveCitySelector.actualSelected.item.county_id?t.tag.find("input").attr("name","city_id[]"):t.tag.find("input").val(PredictiveCitySelector.actualSelected.item.id),PredictiveCitySelector.actualSelected=null}),t.tagit(o),t.find(".ui-autocomplete-input").blur((function(){var e=$.Event("keydown");e.keyCode=$.ui.keyCode.ENTER,$(this).trigger(e)}))},initWithTags:function(e,t,i,a,c){this.selLocation=e,this.selPostalCode=i;var o=[];t.val()&&(o=JSON.parse(t.val())),this.fuzzy=!0===t.data("fuzzy");var r,l=c||"location_id[]",n={enforceWhitelist:!0,whitelist:o,dropdown:{maxItems:"30",classname:"location",fuzzySearch:!0,position:"input"},delimiters:"--",callbacks:{input:function(e){if(PredictiveCitySelector.isRunAutocomplete()){var t=_.get(e,"detail.value",e.detail);r.settings.whitelist.length=0,PredictiveCitySelector._xhr&&(PredictiveCitySelector._xhr.abort(),PredictiveCitySelector._xhr=null);var i=PredictiveCitySelector.getAutocompleteSourceData({term:t});PredictiveCitySelector._xhr=$.ajax({url:PredictiveCitySelector.source,type:"POST",dataType:"json",async:!0,cache:!1,data:$.extend(i,{lang:prof.i18n.currentLanguage(),fuzzy:PredictiveCitySelector.fuzzy}),success:function(e){PredictiveCitySelector.actualMatch=PredictiveCitySelector.onAutoCompleteSuccess(e),r.settings.whitelist=PredictiveCitySelector.actualMatch,r.dropdown.show.call(r,PredictiveCitySelector.fuzzy?"":PredictiveCitySelector.getMatchAsDistrictOrCity(i.term));var t=$(r.DOM.scope).offset(),a=$(r.DOM.scope).width()-12,c=t.top-15,o=t.left+6;r.DOM.dropdown.style.cssText="left: "+o+"px;                                                top: "+c+"px;                                               width: "+a+"px";var l=!1;r.value&&r.value.map((function(e){e.value===PredictiveCitySelector.invalidValue&&(l=!0)})),PredictiveCitySelector.invalidValue&&!l&&(0!==e.length&&PredictiveCitySelector.invalidValue===e[0].name&&(r.addTags(e[0].name),r.settings.whitelist.length=0,r.dropdown.hide.call(r)),PredictiveCitySelector.invalidValue=void 0,l=!1),0==e.length&&PredictiveCitySelector.onAutocompleteEmpty?(PredictiveCitySelector.onAutocompleteEmpty(),PredictiveCitySelector.strict&&$(PredictiveCitySelector.predictiveTextField).val(""),r.settings.whitelist.length=0,r.dropdown.hide.call(r)):-1<i.term.indexOf("Budapest,")&&$(".tagify__input").attr("data-suggest","")}})}},add:function(e){var i=e.detail,a=$(i.tag);$(window).trigger("tags.beforeTagAdded"),a.append($("<input>",{type:"hidden",name:l,value:i.data.value})),1==r.value.length&&t.attr("disabled",!0),$(window).trigger("tags.afterTagAdded")},remove:function(e){r.value.length||(t.val(""),t.attr("disabled",!1)),$(window).trigger("tags.afterTagRemoved")},invalid:function(e){PredictiveCitySelector.invalidValue=e.detail.data.value.charAt(0).toUpperCase()+e.detail.data.value.slice(1),$(window).trigger("tags.afterInvalidTagRemoved")}}};return(r=new Tagify(t.get(0),n)).DOM.dropdown.style.cssText="top: -1000px",r.DOM.input.classList.add("tagify__input--outside"),r.DOM.scope.parentNode.insertBefore(r.DOM.input,r.DOM.scope),$.each(r.value,(function(e,t){var i=$(r.DOM.scope).find("tag").eq(e),a=$("<input>",{type:"hidden",name:l,value:t.value});i.append(a)})),!0===a&&($.each(r.value,(function(e,t){var i=$(r.DOM.scope).find("tag").eq(e);void 0!==t.county_id?i.find("input").attr("name","city_id[]"):i.find("input").val(t.id),i.append($input)})),r.on("add",(function(e){var t=e.detail,i=$(t.tag);PredictiveCitySelector.actualSelected=t,void 0!==t.data.county_id?i.find("input").attr("name","city_id[]"):i.find("input").val(t.data.id),PredictiveCitySelector.actualSelected=null}))),r},beforeTagAdded:function(e,t){if("undefined"!=typeof array){if(-1==array.indexOf(t.tagLabel))return!1;if("not found"==t.tagLabel)return!1}},afterTagAdded:function(e,t){var i=$("#cityNames").val();""!==i?$("#cityNames").val(i+","+t.tagLabel):$("#cityNames").val(t.tagLabel)},afterTagRemoved:function(e,t){var i=$("#cityNames").val().split(","),a=$.inArray(t.tagLabel,i);a>-1&&(i.splice(a),$("#cityNames").val(i.join()))},getCheckedLocations:function(){return this.selLocation.find("input:checked").map((function(){return this.value})).get()},_getDatas:function(e){var t={term:e,tagit:1};return PredictiveCitySelector._disableLocation?t.postal_code=this.selPostalCode.val():t.megyeids=PredictiveCitySelector.getCheckedLocations(),t},autocompleteXHR:function(e,t,i){PredictiveCitySelector._xhr&&(PredictiveCitySelector._xhr.abort(),PredictiveCitySelector._xhr=null);var a=$.extend(!0,{url:PredictiveCitySelector.source,type:"POST",dataType:"json",async:!0,cache:!1,data:$.extend(PredictiveCitySelector.getAutocompleteSourceData(e),{lang:prof.i18n.currentLanguage()})},i);PredictiveCitySelector._xhr=$.ajax(a)},autocompleteSource:function(e,t){PredictiveCitySelector.isRunAutocomplete()&&PredictiveCitySelector.autocompleteXHR(e,t,{data:{fuzzy:PredictiveCitySelector.fuzzy},success:function(e){PredictiveCitySelector.actualMatch=PredictiveCitySelector.onAutoCompleteSuccess(e),e&&e.length&&(PredictiveCitySelector.lastMatch=PredictiveCitySelector.onAutoCompleteSuccess(e)),t(PredictiveCitySelector.actualMatch),0===e.length&&PredictiveCitySelector.onAutocompleteEmpty&&(PredictiveCitySelector.onAutocompleteEmpty(),PredictiveCitySelector.strict&&$(PredictiveCitySelector.predictiveTextField).val(""))}})},isRunAutocomplete:function(){return!PredictiveCitySelector.selLocation||!!PredictiveCitySelector.getCheckedLocations().length},onAutoCompleteSuccess:function(e){return $.map(e,this.autocompleteMapping)},autocompleteMapping:function(e){return{id:e.id,postal_code:e.postal_code,county_id:e.megye_id,label:e.name,value:e.name,country_id:e.country_id}},getAutocompleteSourceData:function(e){return e.term.toLowerCase().indexOf("budapest ")>-1&&(e.term.indexOf("budapest ")>-1?e.term=e.term.replace("budapest ","Budapest, "):e.term=e.term.replace("Budapest ","Budapest, ")),PredictiveCitySelector.selLocation?{megyeids:PredictiveCitySelector.getCheckedLocations(),term:window.districtConverter(e.term).term,tagit:1,group:"id"}:{term:window.districtConverter(e.term).term,tagit:1}},onAutocompleteSelect:function(e,t){PredictiveCitySelector.selPostalCode.val(t.item.postal_code),PredictiveCitySelector.selPostalCode.val(t.item.country_id)},onAutocompleteEmpty:function(){},onAutocompleteCloseWithoutSelect:function(e,t){},forceMustMatch:function(e,t){var i=e.tag.text();if(!PredictiveCitySelector.actualMatch)return!0;var a=$.map(PredictiveCitySelector.actualMatch,(function(e,t){return e.label}));return i=215==i.charCodeAt(i.length-1)?i.slice(0,-1):i,-1!=$.inArray(i,a)||($(".tagit-new input").val(""),"function"==typeof t&&t(),!1)},inArrayCaseInsensitive:function(e,t){return $.each(t,(function(e,t){})),-1},getMatchAsDistrictOrCity:function(e){return $.isArray(e)?isNaN(parseInt(e[0],10))&&-1==e[0].indexOf(" ")?e[0]:e[1]:e}};